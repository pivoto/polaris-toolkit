#parse("/vm/include.vm")
package ${pkgPrefixFacade}${env.rpcPackage.replace('/','.')};

import ${pkgPrefix}${env.entityPackage.replace('/','.')}.${table.javaClassName}${env.entityClassSuffix};
import ${pkgPrefix}${env.servicePackage.replace('/','.')}.${table.javaClassName}${env.serviceClassSuffix};
import ${pkgPrefixFacade}${env.modelPackage.replace('/','.')}.${table.javaClassName}${env.rpcDmlInputClassSuffix};
import ${pkgPrefixFacade}${env.modelPackage.replace('/','.')}.${table.javaClassName}${env.rpcGetInputClassSuffix};
import ${pkgPrefixFacade}${env.modelPackage.replace('/','.')}.${table.javaClassName}${env.rpcListInputClassSuffix};
import ${pkgPrefixFacade}${env.modelPackage.replace('/','.')}.${table.javaClassName}${env.rpcGetOutputClassSuffix};
import ${pkgPrefixFacade}${env.modelPackage.replace('/','.')}.${table.javaClassName}${env.rpcListOutputClassSuffix};

import io.polaris.core.lang.bean.Beans;
import io.polaris.core.lang.bean.IBeanMap;
import io.polaris.bf.common.map.BeanMaps;
import io.polaris.bf.core.context.domain.ExchangeDto;
import io.polaris.bf.core.data.consts.Dml;
import io.polaris.bf.core.data.domain.Page;
import io.polaris.bf.core.data.domain.QueryDto;
import io.polaris.bf.core.rpc.annotation.RpcService;

import lombok.extern.slf4j.Slf4j;
import org.springframework.util.Assert;

import java.util.*;

/**
 * $!{table.name}
 * $!{table.comment}
 * @author $!{env.author}
 * @since ${current.date}
 */
@Slf4j
@RpcService
public class ${table.javaClassName}${env.rpcClassSuffix}{

	private final ${table.javaClassName}${env.serviceClassSuffix} ${table.javaVariableName}${env.serviceClassSuffix};

	public ${table.javaClassName}${env.rpcClassSuffix}(${table.javaClassName}${env.serviceClassSuffix} ${table.javaVariableName}${env.serviceClassSuffix}) {
		this.${table.javaVariableName}${env.serviceClassSuffix} = ${table.javaVariableName}${env.serviceClassSuffix};
	}

	@RpcService(code = "$!{env.rpcCodePrefix}${table.javaClassName}Dml", name = "数据操作")
	public ExchangeDto doDml(${table.javaClassName}${env.rpcDmlInputClassSuffix} input) {
		Assert.notNull(input.getType(), "操作类型不能为空");
		Dml type = input.getType();
		switch (type) {
			case INSERT: {
				${table.javaClassName}${env.entityClassSuffix} entity = BeanMaps.of(input.getParam()).copyToBean(new ${table.javaClassName}${env.entityClassSuffix}());
				${table.javaVariableName}${env.serviceClassSuffix}.insertSelective(entity);
				break;
			}
			case UPDATE: {
				${table.javaClassName}${env.entityClassSuffix} entity = BeanMaps.of(input.getParam()).copyToBean(new ${table.javaClassName}${env.entityClassSuffix}());
				${table.javaVariableName}${env.serviceClassSuffix}.updateSelective(entity);
				break;
			}
			case DELETE: {
				${table.javaClassName}${env.entityClassSuffix} entity = BeanMaps.of(input.getParam()).copyToBean(new ${table.javaClassName}${env.entityClassSuffix}());
				${table.javaVariableName}${env.serviceClassSuffix}.delete(entity);
				break;
			}
			default: // ignore
		}
		return new ExchangeDto();
	}


	@RpcService(code = "$!{env.rpcCodePrefix}${table.javaClassName}Get", name = "单行数据查询")
	public ${table.javaClassName}${env.rpcGetOutputClassSuffix} doGet(${table.javaClassName}${env.rpcGetInputClassSuffix} input) {
		${table.javaClassName}${env.entityClassSuffix} entity = ${table.javaVariableName}${env.serviceClassSuffix}.getUnique(
			BeanMaps.of(input.getParam()).copyToBean(new ${table.javaClassName}${env.entityClassSuffix}())
		);
		${table.javaClassName}${env.rpcGetOutputClassSuffix} output = new ${table.javaClassName}${env.rpcGetOutputClassSuffix}();
		output.setEntity(entity);
		return output;
	}

	@RpcService(code = "$!{env.rpcCodePrefix}${table.javaClassName}List", name = "列表数据查询")
	public ${table.javaClassName}${env.rpcListOutputClassSuffix} doList(${table.javaClassName}${env.rpcListInputClassSuffix} input) {
		${table.javaClassName}${env.rpcListOutputClassSuffix} output = new ${table.javaClassName}${env.rpcListOutputClassSuffix}();
		${table.javaClassName}${env.entityClassSuffix} param = BeanMaps.of(input.getParam()).copyToBean(new ${table.javaClassName}${env.entityClassSuffix}());
		Page page = input.getPage();
		List<${table.javaClassName}${env.entityClassSuffix}> list = ${table.javaVariableName}${env.serviceClassSuffix}.getPage(param, page);
		output.setPage(page);
		output.setList(list);
		return output;
	}

	@RpcService(code = "$!{env.rpcCodePrefix}${table.javaClassName}Query", name = "通用数据查询")
	public ${table.javaClassName}${env.rpcListOutputClassSuffix} doQuery(QueryDto input) {
		${table.javaClassName}${env.rpcListOutputClassSuffix} output = new ${table.javaClassName}${env.rpcListOutputClassSuffix}();
		Page page = input.getPage();
		Map<String, Object> param = input.getParam().getSqlParamMap();
		List<${table.javaClassName}${env.entityClassSuffix}> list = ${table.javaVariableName}${env.serviceClassSuffix}.getPage(param, page);
		output.setPage(page);
		output.setList(list);
		return output;
	}
}

